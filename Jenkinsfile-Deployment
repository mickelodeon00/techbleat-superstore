pipeline {
    agent any
    
    environment {
        VM_IP       = credentials('vm-public-ip')
        DB_ENDPOINT = credentials('db-endpoint')
        DB_USERNAME = credentials('db-username')
        DB_PASSWORD = credentials('db-password')
    }
    
    stages {
        stage('Deploy Backend') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ec2-user@\${VM_IP} bash -s << 'ENDSSH'
                            rm -rf /home/ec2-user/fruits-veg_market
                            cd /home/ec2-user
                            git clone -b mini-project https://github.com/techbleat/fruits-veg_market.git
                            
                            cd fruits-veg_market/backend-api
                            python3 -m venv venv
                            source venv/bin/activate
                            pip install --quiet -r requirements.txt
                            
                            sed -i 's|postgresql+psycopg://user:pass@db.server:5432/postgres|postgresql+psycopg://${DB_USERNAME}:${DB_PASSWORD}@${DB_ENDPOINT}/postgres?sslmode=require|g' main.py
                            
                            pkill -f uvicorn || true
                            sleep 2
                            nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
                            
                            echo "Backend deployed"
ENDSSH
                    """
                }
            }
        }
        
        stage('Deploy Frontend') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ec2-user@\${VM_IP} bash -s << 'ENDSSH'
                            cd /home/ec2-user/fruits-veg_market/frontend
                            sed -i 's|http://localhost:8000/api/products|/api/products|g' index.html
                            
                            sudo cp -r /home/ec2-user/fruits-veg_market/frontend/* /usr/share/nginx/html/
                            sudo systemctl restart nginx
                            
                            echo "Frontend deployed"
ENDSSH
                    """
                }
            }
        }
        

    }
}